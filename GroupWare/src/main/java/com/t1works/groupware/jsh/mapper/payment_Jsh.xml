<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="payment_Jsh">


<select id="generalPayment_List"  resultType="com.t1works.groupware.jsh.model.ElectronPayJshVO">
			select  row_number() over(order by a.ano desc ) as RNO,
			       		 a.ano ,ncatname, atitle, name ,dname,asdate    
			from tbl_approval a left join tbl_norapproval n
			on a.ano = n.fk_ano
			left join 
			(select employeeid ,name , fk_dcode
			 from tbl_employee 
			)e
			on a.fk_employeeid = e.employeeid
			left join 
			(select dcode, dname
			from tbl_department
			)d
			on e.fk_dcode = d.dcode
			where anocode= 1
	</select>

  <!-- === 페이징 처리를 안한 검색어가 있는 전체 글목록 보여주기 === -->
	<select id="electronListSearch"  parameterType="HashMap"  resultType="com.t1works.groupware.jsh.model.ElectronPayJshVO">
			select  a.ano ,ncatname, atitle, name ,dname,asdate    
			from tbl_approval a left join tbl_norapproval n
			on a.ano = n.fk_ano
			left join 
			(select employeeid ,name , fk_dcode
			 from tbl_employee 
			)e
			on a.fk_employeeid = e.employeeid
			left join 
			(select dcode, dname
			from tbl_department
			)d
			on e.fk_dcode = d.dcode
			where anocode= 1
				<if test=' searchCategory == "" and searchType != "" and searchWord != "" '>
			         and lower(${searchType}) like '%' || lower(#{searchWord}) || '%'
			     </if>
			      <if test=' searchCategory != ""  and searchType == ""   and searchWord == "" '>
			     	 	and ncat= #{searchCategory}
			     </if>
			      <if test=' searchCategory != ""  and searchType != ""   and searchWord == "" '>
			     	 	and ncat= #{searchCategory}
			     </if>
			     <if test=' searchCategory != ""  and searchType != ""    and searchWord != "" '>
				     	 and ncat= #{searchCategory}
				         and lower(${searchType}) like '%'|| lower(#{searchWord}) ||'%'
				  </if>
		      order by  a.ano desc
	</select>

  <!-- === 검색어 입력시 자동글 완성하기  === -->
     <select id="wordSearchShow" parameterType="HashMap" resultType="String">
			<choose>
				<when test="searchType eq 'name'"> <!-- if -->
		            select distinct ${searchType}
		        </when>
		         <otherwise>   <!-- else -->
            		select ${searchType}
         		</otherwise>
			</choose>
			from tbl_approval a left join tbl_norapproval n
					  on a.ano = n.fk_ano
					  left join 
				  	 (select employeeid ,name , fk_dcode
					  from tbl_employee 
					 )e
					 on a.fk_employeeid = e.employeeid
				     where anocode= 1
			 			 and lower(${searchType}) like '%' || lower(#{searchWord}) || '%'
		    <if test="searchType neq 'name'">
		     order by  a.ano desc
		    </if>
	</select>


 <!-- === 총 게시물 건수(totalCount) 구하기 - 검색이 있을때와 검색이 없을때로 나뉜다. === -->
		<select id="getTotalCount" parameterType="HashMap" resultType="int">
			select  count(*) 
			from tbl_approval  a left join tbl_norapproval n
			on a.ano = n.fk_ano
			where anocode= '1'
				<if test=' searchCategory == "" and searchType != "" and searchWord != "" '>
			         and lower(${searchType}) like '%' || lower(#{searchWord}) || '%'
			     </if>
			      <if test=' searchCategory != ""  and searchType == ""   and searchWord == "" '>
			     	 	and ncat= #{searchCategory}
			     </if>
			      <if test=' searchCategory != ""  and searchType != ""   and searchWord == "" '>
			     	 	and ncat= #{searchCategory}
			     </if>
			     <if test=' searchCategory != ""  and searchType != ""    and searchWord != "" '>
				     	 and ncat= #{searchCategory}
				         and lower(${searchType}) like '%'|| lower(#{searchWord}) ||'%'
				  </if>
		</select>

		<!--  //페이징 처리한 글목록 가져오기(검색이 있든지, 검색이 없든지 모두 다 포함한 것) -->
		<select id="electronListSearchWithPaging" parameterType="HashMap" resultType="com.t1works.groupware.jsh.model.ElectronPayJshVO">
			select ano ,ncatname, atitle, name ,dname,to_char(asdate,'yyyy-mm-dd') as asdate
				  , fileName, orgFilename, fileSize   
			from
			(
			select row_number() over(order by a.ano desc) AS rno  
			      ,a.ano ,ncatname, atitle, name ,dname,asdate    
			       , fileName, orgFilename, fileSize 
			from tbl_approval a left join tbl_norapproval n
			on a.ano = n.fk_ano
			left join 
			(select employeeid ,name , fk_dcode
			from tbl_employee 
			)e
			on a.fk_employeeid = e.employeeid
			left join 
			(select dcode, dname
			from tbl_department
			)d
			on e.fk_dcode = d.dcode
			where anocode= 1
				 <if test=' searchCategory == "" and searchWord != "" '>
			         and lower(${searchType}) like '%' || lower(#{searchWord}) || '%'
			     </if>
			      <if test=' searchCategory != ""    and searchWord == "" '>
			     	 	and ncat= #{searchCategory}
			     </if>
			     <if test=' searchCategory != ""   and searchWord != "" '>
				     	 and ncat= #{searchCategory}
				         and lower(${searchType}) like '%'|| lower(#{searchWord}) ||'%'
				  </if>
				 ) V
		      	where rno between #{startRno} and #{endRno}
		</select>
		
		
		<!-- // 하나의 일반결재내역 문서 보여주기 -->
		<select id="generalOneView" parameterType="HashMap" resultType="com.t1works.groupware.jsh.model.ElectronPayJshVO">
			  
			  select ncatname, arecipient1, atitle, name ,dname, apaper ,a.ano , acontent ,to_char(asdate,'yyyy-mm-dd') as asdate, fileName ,orgFilename, fileSize 
			  <choose>
				<when test="ncatname eq'회의록'">
				 , mdate 
				</when>
				<when test="ncatname eq'위임장'">
				, fk_wiimdate 
				</when>
				<when test="ncatname eq'협조공문'">
				 ,nvl(comname,'없습니다.') as comname
				</when>
				
				</choose>
			 
			from tbl_approval a 
				<if test="ncatname eq'회의록'">
					left join tbl_minutes m 
					on m.fk_ano = a.ano
				</if>
				<if test="ncatname eq'위임장'">
					left join tbl_wiimjang w 
					on w.fk_ano = a.ano
				</if>
				<if test="ncatname eq'협조공문'">
					left join tbl_coofficial c 
					on c.fk_ano = a.ano
				</if>
			left join tbl_norapproval n
			on a.ano = n.fk_ano
			left join 
			(select employeeid ,name , fk_dcode
			from tbl_employee 
			)e
			on a.fk_employeeid = e.employeeid
			left join 
			(select dcode, dname
			from tbl_department
			)d
			on e.fk_dcode = d.dcode
			where anocode= 1 and ano=#{ano}
		</select>
		
		
		
		
		<!-- //하나의 일반결재내역에서 결재의견 목록 보여주기 -->
		<select id="oneOpinionList" parameterType="HashMap"  resultType="com.t1works.groupware.jsh.model.ElectronPayJshVO">
			select dname ,name, pname,odate,ocontent
			from tbl_aopinion a left join tbl_employee e
				 on a.fk_employeeid = e.employeeid
					left join tbl_department d
				 on e.fk_dcode = d.dcode
					left join tbl_position p
				 on e.fk_pcode=p.pcode
			where fk_ano =#{ano}
		
		</select>
		
		
	    
		
		<!-- //일반결재 글쓰기 -->
		<select id="WriteJsh" parameterType="HashMap" resultType="com.t1works.groupware.jsh.model.ElectronPayJshVO">
			select dname ,d.dcode , e.managerid as managerid
			from tbl_employee e left join tbl_department d
			on d.dcode = e.fk_dcode
			where employeeid = #{userid}
		</select>
		
		<!-- 수신자 정보 select해오기 -->
		<select id="mWriteJsh" parameterType="HashMap" resultType="com.t1works.groupware.jsh.model.ElectronPayJshVO">
			 select name, employeeid  ,pname
			 from tbl_employee e left join tbl_position p
			 on e.fk_pcode = p. pcode
			 where employeeid=(select managerid from tbl_employee where employeeid= #{userid}) 
		</select>
		
		
		
		 <!--  1) insert될 문서번호를 알아온다 -->
		<select id="insertno" resultType="String">
			select seq_tbl_approval.nextval from dual
		</select>
		
		<!-- 2)전자결재테이블 insert -->
		<insert id="Electricadd" parameterType="com.t1works.groupware.jsh.model.ElectronPayJshVO"  >
			insert into tbl_approval (ano,fk_employeeid,anocode,arecipient1, atitle ,astatus , acontent ,asdate,apaper) 
			values (#{ano}, #{fk_employeeid}, '1' , #{arecipient1}, #{atitle} ,0 , #{acontent} ,sysdate,0)
		</insert>
		
		<!--  3) 일반결재테이블에 isnert -->
		<insert id="Generaladd" parameterType="com.t1works.groupware.jsh.model.ElectronPayJshVO"  >
			
				insert  into tbl_norapproval (ncat,fk_ano,ncatname)  
				<if test="ncatname eq'회의록'">
					values('1',#{ano},'회의록')
				</if>
				<if test="ncatname eq'위임장'">
					 values('2',#{ano},'위임장')
				</if>
				<if test="ncatname eq'외부공문'">
					values('3',#{ano},'외부공문')
				</if>
				<if test="ncatname eq'협조공문'">
					values('4',#{ano},'협조공문')
				</if>
		</insert>
		
		<!-- 4) ncatname 조건에 따라 (회의록,위임장,외부공문,협조공문) 테이블에 insert 시켜줌  -->
		<insert id="selectadd" parameterType="com.t1works.groupware.jsh.model.ElectronPayJshVO"  >
			<if test="ncatname eq'회의록'">
				insert into tbl_minutes (mno , fk_ncat, fk_ano, mdate)         values(seq_tbl_minutes.nextval,'1',#{ano},#{mdate})
			</if>
			<if test="ncatname eq'위임장'">
				insert into tbl_wiimjang(wno , fk_ncat, fk_ano, fk_wiimdate)   values(seq_tbl_wiimjang.nextval,'2',#{ano},#{fk_wiimdate})
			</if>
			<if test="ncatname eq'외부공문'">
				into tbl_exofficial(eno, fk_ncat ,fk_ano)                      values(seq_tbl_exofficial.nextval,'3',#{ano})
			</if>
			<if test="ncatname eq'협조공문'">
				insert into tbl_coofficial(cno, fk_ncat ,fk_ano, comname)       values(seq_tbl_coofficial.nextval,'4',#{ano},#{comname})
			</if>
		</insert>
		
		
		<!--글쓰기 ( 첨부파일이 있는 경우 ) = 전자결재테이블 insert -->
		<insert id="Electricadd_withFile" parameterType="com.t1works.groupware.jsh.model.ElectronPayJshVO"  >
			insert into tbl_approval (ano,fk_employeeid,anocode,arecipient1, atitle ,astatus , acontent ,asdate, apaper, fileName, orgFilename, fileSize) 
			values (#{ano}, #{fk_employeeid}, '1' , #{arecipient1}, #{atitle} ,0 , #{acontent} ,sysdate,0 , #{fileName}, #{orgFilename}, #{fileSize})
		</insert>
		
		<!--글쓰기 저장( 첨부파일이 없는 경우 ) = 전자결재테이블 insert -->
		<insert id="ElectricSave" parameterType="com.t1works.groupware.jsh.model.ElectronPayJshVO"  >
			insert into tbl_approval (ano,fk_employeeid,anocode,arecipient1, atitle ,astatus , acontent ,asdate, apaper) 
			values (#{ano}, #{fk_employeeid}, '1' , #{arecipient1}, #{atitle} ,0 , #{acontent} ,sysdate, 2 )
		</insert>
		
		<!--글쓰기 저장( 첨부파일이 있는 경우 ) = 전자결재테이블 insert -->
		<insert id="ElectricSave_withFile" parameterType="com.t1works.groupware.jsh.model.ElectronPayJshVO"  >
			insert into tbl_approval (ano,fk_employeeid,anocode,arecipient1, atitle ,astatus , acontent ,asdate, apaper, fileName, orgFilename, fileSize) 
			values (#{ano}, #{fk_employeeid}, '1' , #{arecipient1}, #{atitle} ,0 , #{acontent} ,sysdate, 2 , #{fileName}, #{orgFilename}, #{fileSize})
		</insert>
		
	
	
	
	
	<!-- ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////  -->
	<!-- 지출결재 -->
	
		<!-- === 검색어 입력시 자동글 완성하기  === -->
	     <select id="expWordSearchShow" parameterType="HashMap" resultType="String">
				<choose>
					<when test="searchType eq 'name'"> <!-- if -->
			            select distinct ${searchType}
			        </when>
			         <otherwise>   <!-- else -->
	            		select ${searchType}
	         		</otherwise>
				</choose>
				from tbl_approval a left join 
					  	 (select employeeid ,name , fk_dcode
						  from tbl_employee 
						 )e
						 on a.fk_employeeid = e.employeeid
					     where anocode= 2
				 			   and lower(${searchType}) like '%' || lower(#{searchWord}) || '%'
			    <if test="searchType neq 'name'">
			     order by  a.ano desc
			    </if>
		</select>


       <!-- === 총 게시물 건수(totalCount) 구하기 - 검색이 있을때와 검색이 없을때로 나뉜다. === -->
		<select id="expGetTotalCount" parameterType="HashMap" resultType="int">
			select  count(*) 
			from tbl_approval  a left join tbl_spenda s
			on a.ano = s.fk_ano
			where anocode= '2'
				<if test=' searchCategory == "" and searchType != "" and searchWord != "" '>
			         and lower(${searchType}) like '%' || lower(#{searchWord}) || '%'
			     </if>
			      <if test=' searchCategory != ""  and searchType == ""   and searchWord == "" '>
			     	 	and scat= #{searchCategory}
			     </if>
			      <if test=' searchCategory != ""  and searchType != ""   and searchWord == "" '>
			     	 	and scat= #{searchCategory}
			     </if>
			     <if test=' searchCategory != ""  and searchType != ""    and searchWord != "" '>
				     	 and scat= #{searchCategory}
				         and lower(${searchType}) like '%'|| lower(#{searchWord}) ||'%'
				  </if>
		</select>

		<!--  //페이징 처리한 글목록 가져오기(검색이 있든지, 검색이 없든지 모두 다 포함한 것) -->
		<select id="expListSearchWithPaging" parameterType="HashMap" resultType="com.t1works.groupware.jsh.model.ElectronPayJshVO">
			select rno ,ano ,scatname, atitle, name ,dname,to_char(asdate,'yyyy-mm-dd') as asdate
				  , fileName, orgFilename, fileSize   
			from
			(
			select row_number() over(order by a.ano desc) AS rno  
			      ,a.ano ,scatname, atitle, name ,dname,asdate    
			       , fileName, orgFilename, fileSize 
			from tbl_approval a left join tbl_spenda s
			on a.ano = s.fk_ano
			left join 
			(select employeeid ,name , fk_dcode
			from tbl_employee 
			)e
			on a.fk_employeeid = e.employeeid
			left join 
			(select dcode, dname
			from tbl_department
			)d
			on e.fk_dcode = d.dcode
			where anocode= 2
				 <if test=' searchCategory == "" and searchWord != "" '>
			         and lower(${searchType}) like '%' || lower(#{searchWord}) || '%'
			     </if>
			      <if test=' searchCategory != ""    and searchWord == "" '>
			     	 	and scat= #{searchCategory}
			     </if>
			     <if test=' searchCategory != ""   and searchWord != "" '>
				     	 and scat= #{searchCategory}
				         and lower(${searchType}) like '%'|| lower(#{searchWord}) ||'%'
				  </if>
				 ) V
		      	where rno between #{startRno} and #{endRno}
		</select>
			
		
		
		<!-- // 하나의 전자결재내역 문서 보여주기 -->
		<select id="expOneView" parameterType="HashMap" resultType="com.t1works.groupware.jsh.model.ElectronPayJshVO">
			  
			  select scatname, arecipient1, atitle, name ,dname, apaper ,a.ano , acontent ,to_char(asdate,'yyyy-mm-dd') as asdate, fileName ,orgFilename, fileSize 
			  <choose>
				<when test="scatname eq'지출결의서'">
				 , exdate,  exprice
				</when>
				<when test="scatname eq'법인카드사용신청서'">
				, codate ,cocardnum ,copurpose,coprice
				</when>
				</choose>
			 
			from tbl_approval a 
				<if test="scatname eq'지출결의서'">
					left join tbl_expense ex 
					on ex.fk_ano = a.ano
				</if>
				<if test="scatname eq'법인카드사용신청서'">
					left join tbl_cocard c 
					on c.fk_ano = a.ano
				</if>
				
			left join tbl_spenda s
			on a.ano = s.fk_ano
			left join 
			(select employeeid ,name , fk_dcode
			from tbl_employee 
			)e
			on a.fk_employeeid = e.employeeid
			left join 
			(select dcode, dname
			from tbl_department
			)d
			on e.fk_dcode = d.dcode
			where anocode= 1 and ano=#{ano}
		</select>
		
		
		
		
		
		
		
		
		
		
		
		
		
</mapper>




